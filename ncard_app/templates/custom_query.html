{% extends 'events/base.html' %}

{% block title %}NCARD Database{% endblock %}

{% block custom_css %}
<style type="text/css">
    .bootstrap-select * {
        overflow-x: hidden;
    }
    .bootstrap-select > button {
        border: 1px solid #ced4da;
    }
    #startingTable {
        margin-bottom: 1em;
    }
    #startingTable select {
        width: 20em;
        display: inline-block;
    }
    .field-row {
        display: flex;
        flex-wrap: wrap;
    }
    .field-row > * {
        margin-right: 0.5em;
        margin-bottom: 0.5em;
    }
    .field-row > div {
        width: 12em;
    }
    .field-row .bootstrap-select {
        width: 100% !important;
    }

    .field-row button {
        width: 2.5em;
    }
    .add-button {
        width: 8.5em;
        margin-bottom: 1em;
    }
    .filter-section {
        margin-bottom: 1em;
    }
    .filter-container {
        padding-left: 3em;
    }
    .filter-container div {
        margin-bottom: 0.5em;
    }
    .filter-container button {
        width: 2.5em;
        margin-right: 0.5em;
        vertical-align: baseline;
        background-color: white;
    }
    .filter-container div:not(:last-child)::after {
        content: " OR";
    }
    .condition-argument {
        width: 20em;
        display: inline;
        margin-left: 0.5em;
        margin-right: 0.5em;
    }
</style>
{% endblock %}

{% block content %}
    <h1 class="mb-4">Query</h1>
    <div class="row mb-4">
        <select id="startingTableSelector" class="selectpicker form-control" data-live-search="true">
            <option value="" selected>Starting table...</option>
        </select>
        {% csrf_token %}
    </div>
    <div id="querySettings" style="display:none;">
        <h2>Output Fields</h2>
        <div><button id="addFieldRow" class="btn btn-outline-success add-button">Add Field</button></div>
        <div id="fieldRows"></div>
        <h2>Filter</h2>
        <div><button id="addFilterSection" class="btn btn-outline-success add-button">Add Filter</button></div>
        <div id="filterSections"></div>
        <h2>Results</h2>
        <div><button id="runQueryButton" class="btn btn-outline-success add-button">Get JSON</button></div>
        <pre id="queryResult" style="display:block; white-space: break-spaces;"></pre>
    </div>
{% endblock %}

{% block custom_js %}
<script>
let schema = null;
let selectedModel = null;

function fieldSelectHandler(selectorContainer, selector, onChange) {
    return function (e) {
        while (selectorContainer.nextSibling) {
            selectorContainer.nextSibling.remove();
        }
        const selectedOption = selector.options[selector.selectedIndex];
        const selectedFieldType = selectedOption.dataset.fieldType;
        if (schema.hasOwnProperty(selectedFieldType)) {
            createFieldSelect(selectorContainer.parentNode, selectedFieldType, onChange);
        }
        onChange();
    }
}

function deleteRow(row) {
    return function (e) {
        row.remove();
    }
}

function moveRowUp(row) {
    return function (e) {
        if (row.previousElementSibling) {
            row.parentNode.insertBefore(row, row.previousElementSibling);
        }
        e.target.blur()
    }
}

function moveRowDown(row) {
    return function (e) {
        if (row.nextElementSibling) {
            row.parentNode.insertBefore(row, row.nextElementSibling.nextElementSibling);
        }
        e.target.blur()
    }
}

function createOption(parent, value, text) {
    const option = document.createElement("option");
    option.value = value;
    option.text = text;
    parent.appendChild(option);
    return option;
}

function createFieldSelect(parent, modelName, onChange) {
    const selectorContainer = document.createElement("div");
    parent.appendChild(selectorContainer);
    
    const selector = document.createElement("select");
    selector.className = 'field-select';
    selector.addEventListener("change", fieldSelectHandler(selectorContainer, selector, onChange));
    selectorContainer.appendChild(selector);
    
    const defaultOption = createOption(selector, "", "Query " + modelName + "...");
    defaultOption.dataset.fieldType = "";
    defaultOption.selected = "selected";
    for (const field of schema[modelName]) {
        const newOption = createOption(selector, field.name, field.label);
        newOption.dataset.fieldType = field.type;
    }
    selector.dataset.liveSearch = true;
    $(selector).selectpicker();
}

function createButton(parent, className, text, action) {
    const button = document.createElement("button");
    button.className = className;
    button.addEventListener("click", action);
    button.appendChild(document.createTextNode(text));
    parent.appendChild(button);
}

function addFieldRow(e) {
    if (selectedModel === null) {
        return;
    }
    const fieldRow = document.createElement("div");
    fieldRow.className = "field-row";
    createButton(fieldRow, "btn btn-outline-danger", "X", deleteRow(fieldRow));
    createButton(fieldRow, "btn btn-outline-secondary", "\u25B2", moveRowUp(fieldRow));
    createButton(fieldRow, "btn btn-outline-secondary", "\u25BC", moveRowDown(fieldRow));
    createFieldSelect(fieldRow, selectedModel, function() {});
    document.getElementById("fieldRows").appendChild(fieldRow);
    e.target.blur();
}

function addFilterCondition(filterContainer, selector) {
    return function (e) {
        if (selector.selectedIndex > 0) {
            const selectedOption = selector.options[selector.selectedIndex];
            const newFilter = document.createElement("div");
            newFilter.className = "filter-condition";
            
            const filterID = document.createElement("input");
            filterID.type = "hidden";
            filterID.className = "condition-id";
            filterID.value = selectedOption.value;

            const filterArgument = document.createElement("input");
            filterArgument.type = "text";
            filterArgument.className = "form-control condition-argument";

            createButton(newFilter, "btn btn-outline-danger", "X", deleteRow(newFilter));
            newFilter.appendChild(filterID);
            newFilter.appendChild(document.createTextNode(selectedOption.text));
            newFilter.appendChild(filterArgument);
            
            filterContainer.appendChild(newFilter);
            selector.selectedIndex = 0;
            selector.blur();
        }
    }
}

function addFilterSection(e) {
    if (selectedModel === null) {
        return;
    }
    const filterSection = document.createElement("div");
    filterSection.className = "filter-section";
    
    const filterContainer = document.createElement("div");
    filterContainer.className = "filter-container bg-light";
    
    const conditionSelector = document.createElement("select");
    conditionSelector.className = "form-select";
    options = ["(Add condition)", "Contains", "Starts with", "Ends with", "Equals"];
    for (let i = 0; i < options.length; ++i) {
        createOption(conditionSelector, options[i], options[i]);
    }
    conditionSelector.selectedIndex = 0;
    conditionSelector.addEventListener("change", addFilterCondition(filterContainer, conditionSelector));

    const fieldRow = document.createElement("div");
    fieldRow.className = "field-row";
    createButton(fieldRow, "btn btn-outline-danger", "X", deleteRow(filterSection));
    createFieldSelect(fieldRow, selectedModel, function() { filterContainer.innerHTML = ""; });

    filterSection.appendChild(fieldRow);
    filterSection.appendChild(filterContainer);
    filterSection.appendChild(conditionSelector);
    document.getElementById("filterSections").appendChild(filterSection);
    e.target.blur();
}

function selectStartingModel(e) {
    const startingTableSelector = document.getElementById("startingTableSelector");
    const selectedValue = startingTableSelector.value;
    if (selectedModel != selectedValue) {
    
        const fieldRows = document.getElementById("fieldRows");
        const filterSections = document.getElementById("filterSections");
        
        if (fieldRows.childNodes.length !== 0 || filterSections.childNodes.length !== 0) {
            if (!confirm("The current query will be erased if you change the starting table. Continue?")) {
                startingTableSelector.value = selectedModel;
                $(startingTableSelector).selectpicker("refresh");
                return;
            }
        }
    
        selectedModel = selectedValue;

        fieldRows.innerHTML = "";
        filterSections.innerHTML = "";
        document.getElementById("querySettings").style.display = selectedValue ? "block" : "none";
    }
}

function parseFieldRow(row) {
    let fields = [];
    for (const field of row.querySelectorAll("select.field-select")) {
        if (field.value) {
            fields.push(field.value);
        }
    }
    return fields;
}

function parseFilterCondition(cond) {
    return {
        id: cond.getElementsByClassName("condition-id")[0].value,
        arg: cond.getElementsByClassName("condition-argument")[0].value
    };
}

function parseFilterSection(sect) {
    return {
        field: parseFieldRow(sect.getElementsByClassName("field-row")[0]),
        conditions: Array.from(sect.getElementsByClassName("filter-container")[0].getElementsByClassName("filter-condition"), parseFilterCondition)
    };
}

function parseQuery() {
    return {
        startTable: selectedModel,
        fields: Array.from(document.getElementById("fieldRows").getElementsByClassName("field-row"), parseFieldRow),
        filters: Array.from(document.getElementById("filterSections").getElementsByClassName("filter-section"), parseFilterSection)
    };
}

const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
const schemaLocation = "{% url 'custom-query-schema' %}";
window.addEventListener('load', (event) => {
    fetch(schemaLocation)
    .then((response) => response.json())
    .then((loadedSchema) => {
        schema = loadedSchema;
        const startingTableSelector = document.getElementById("startingTableSelector");
        for (const modelName in schema) {
            // TODO: Use plural verbose name of model as its label
            const option = createOption(startingTableSelector, modelName, modelName);
            option.dataset.tokens = modelName
        }
        startingTableSelector.addEventListener("change", selectStartingModel);
        $(startingTableSelector).selectpicker("refresh");
        document.getElementById("addFieldRow").addEventListener("click", addFieldRow);
        document.getElementById("addFilterSection").addEventListener("click", addFilterSection);
        document.getElementById("runQueryButton").addEventListener("click", (e) => {
            fetch("{% url 'custom-query-data' %}", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(parseQuery())
            })
            .then((responseObj) => responseObj.text())
            .then((response) => {
                document.getElementById("queryResult").innerText = response;
            });
        });
    });
});
</script>
{% endblock %}