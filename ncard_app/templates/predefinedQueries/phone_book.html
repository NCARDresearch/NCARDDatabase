{% extends 'events/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Phone Book{% endblock %}

{% block content%}
    <h1>Phone Book</h1>

        {% csrf_token %}
    <style>
        table, th, td {
            border: 1px solid black;
        }
    </style>
<table id="query-form"  class="table table-striped ">
    {% csrf_token %}
    <tr>
        <th scope="col"> Title </th>
        <th scope="col"> Full Name </th>
        <th scope="col"> Organization Name </th>
        <th scope="col"> Phone(office) </th>
        <th scope="col"> Phone(Mobile) </th>
        <th scope="col"> Email </th>
    </tr>
    {% for ele in data %}
        <tr>
            <td>
                {{ ele.primary_contact.title }}
            </td>
            <td>
                {% if ele.primary_contact.surname_first %} {{ ele.primary_contact.surname }}
                    {{ ele.primary_contact.given_name }}
                {% else %}  {{ ele.primary_contact.given_name }}  {{ ele.primary_contact.surname }}
                {% endif %}
            </td>
            <td>
                {{ ele.name }}
            </td>
            <td>
                {{ ele.primary_contact.contact.phone_office }}
            </td>
            <td>
                {{ ele.primary_contact.contact.phone_mobile }}
            </td>
            <td>
                {{ ele.primary_contact.contact.email }}
            </td>
        </tr>
    {% endfor %}
</table>
<button onclick="get_export()">export</button>

{% endblock %}


{% block custom_js %}
    <script>
function get_export() {
        const table = document.getElementById("query-form");
        const data = []

        for (var i = 0, rows = table.rows.length; i < rows; i++) {
            for (var j = 0, cells = table.rows[i].cells.length; j < cells; j++) {
                if (!data[i]) {
                    data[i] = new Array();
                }

                data[i][j] = " " + table.rows[i].cells[j].innerText

            }
        }

        let csvContent = "";
        csvContent=data.map(e => e.join(",")).join("\n")

        const a = document.createElement('a')
        a.target = '_blank';
        const blob = new Blob([csvContent], {type: "data:text/csv;charset=utf-8,"})
        const url = URL.createObjectURL(blob)
        a.setAttribute('href', url)
        a.setAttribute('download', "organisation.csv")
        a.click()

    }

    </script>

{% endblock %}

